#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
NETTOYAGE PRODUCTION FINAL
Supprime tous les fichiers temporaires et pr√©pare pour commit
"""

import os
import subprocess
import shutil
from pathlib import Path

def analyze_git_status():
    """Analyse l'√©tat Git actuel"""
    print("üîç ANALYSE GIT STATUS")
    print("=" * 40)
    
    try:
        result = subprocess.run(['git', 'status', '--porcelain'], 
                              capture_output=True, text=True, cwd='.')
        
        if result.returncode == 0:
            lines = result.stdout.strip().split('\n') if result.stdout.strip() else []
            
            modified_files = []
            untracked_files = []
            deleted_files = []
            
            for line in lines:
                if line.strip():
                    status = line[:2]
                    filename = line[3:]
                    
                    if 'M' in status:
                        modified_files.append(filename)
                    elif 'D' in status:
                        deleted_files.append(filename)
                    elif '??' in status:
                        untracked_files.append(filename)
            
            print("üìù FICHIERS MODIFI√âS:")
            for f in modified_files:
                print(f"   ‚úèÔ∏è  {f}")
            
            print(f"\nüóëÔ∏è  FICHIERS SUPPRIM√âS:")
            for f in deleted_files:
                print(f"   ‚ùå {f}")
            
            print(f"\n‚ùì FICHIERS NON SUIVIS:")
            for f in untracked_files:
                if any(pattern in f for pattern in ['test_', 'debug_', 'cleanup_']):
                    print(f"   üóëÔ∏è  {f} (√Ä SUPPRIMER)")
                else:
                    print(f"   ‚ûï {f} (√Ä AJOUTER)")
            
            return modified_files, untracked_files, deleted_files
            
    except Exception as e:
        print(f"‚ùå Erreur git status: {e}")
        return [], [], []

def cleanup_temporary_files():
    """Supprime tous les fichiers temporaires"""
    print(f"\nüßπ SUPPRESSION FICHIERS TEMPORAIRES")
    print("=" * 40)
    
    # Fichiers √† supprimer
    files_to_remove = [
        # Tests de d√©veloppement
        "test_final_setup_history.py",
        "test_installation_complete.py", 
        "test_security.py",
        "test_curl_fix.py",
        
        # Scripts de debug
        "debug_conversation_manager_fix.py",
        "debug_curl_multiline.py",
        "debug_editable_instructions.py",
        "debug_openai_issue.py", 
        "debug_setup_history_logic_corrections.py",
        "debug_setup_history_modifications.py",
        "debug_setup_history_validation.py",
        
        # Corrections temporaires
        "correction_finale_curl.py",
        "patch_curl_multiline.py",
        "fix_openai_support.py",
        "validation_setup_history_improvements.py",
        
        # Scripts de nettoyage eux-m√™mes
        "cleanup_final.py",
        "project_cleanup.py",
        
        # Logs
        "debug_curl.log",
        
        # Ce script apr√®s ex√©cution
        "production_cleanup.py"
    ]
    
    removed_count = 0
    
    for filename in files_to_remove:
        filepath = Path(filename)
        if filepath.exists():
            try:
                filepath.unlink()
                print(f"‚úÖ Supprim√©: {filename}")
                removed_count += 1
            except Exception as e:
                print(f"‚ùå Erreur {filename}: {e}")
        else:
            print(f"‚ö™ Absent: {filename}")
    
    # Nettoyer __pycache__
    pycache_dirs = list(Path(".").rglob("__pycache__"))
    for pycache_dir in pycache_dirs:
        if pycache_dir.is_dir():
            try:
                shutil.rmtree(pycache_dir)
                print(f"‚úÖ Supprim√©: {pycache_dir}")
                removed_count += 1
            except Exception as e:
                print(f"‚ùå Erreur {pycache_dir}: {e}")
    
    # Supprimer dossiers obsol√®tes
    obsolete_folders = [
        "profiles_backup_conversation",
        "development"
    ]
    
    for folder in obsolete_folders:
        folder_path = Path(folder)
        if folder_path.exists() and folder_path.is_dir():
            try:
                shutil.rmtree(folder_path)
                print(f"‚úÖ Dossier supprim√©: {folder}")
                removed_count += 1
            except Exception as e:
                print(f"‚ùå Erreur dossier {folder}: {e}")
    
    return removed_count

def check_yaml_files():
    """V√©rifie et supprime les fichiers YAML obsol√®tes"""
    print(f"\nüìÑ V√âRIFICATION FICHIERS YAML")
    print("=" * 40)
    
    yaml_files = list(Path(".").glob("*.yaml"))
    
    if not yaml_files:
        print("‚úÖ Aucun fichier YAML trouv√©")
        return 0
    
    removed_count = 0
    
    for yaml_file in yaml_files:
        # Garder seulement les YAML essentiels (aucun pour l'instant)
        if yaml_file.name in ["config.yaml"]:  # √Ä supprimer aussi car obsol√®te
            print(f"üóëÔ∏è  YAML obsol√®te d√©tect√©: {yaml_file.name}")
            try:
                yaml_file.unlink()
                print(f"‚úÖ Supprim√©: {yaml_file.name}")
                removed_count += 1
            except Exception as e:
                print(f"‚ùå Erreur {yaml_file.name}: {e}")
        else:
            print(f"‚ö†Ô∏è  YAML non reconnu: {yaml_file.name}")
    
    return removed_count

def validate_production_files():
    """Valide que les fichiers essentiels sont pr√©sents"""
    print(f"\n‚úÖ VALIDATION FICHIERS PRODUCTION")
    print("=" * 40)
    
    essential_files = [
        "main.py",
        "gui.py", 
        "config_manager.py",
        "conversation_manager.py",
        "system_profile_generator.py",
        "api_response_parser.py",  # NOUVEAU
        "utils.py",
        "install_templates.py",    # NOUVEAU
        "requirements.txt",
        "setup.py",
        "RUN.bat",
        "README.md"
    ]
    
    missing_files = []
    
    for file in essential_files:
        if Path(file).exists():
            print(f"‚úÖ {file}")
        else:
            print(f"‚ùå MANQUANT: {file}")
            missing_files.append(file)
    
    return len(missing_files) == 0

def production_cleanup():
    """Nettoyage radical pour la production"""
    
    print("üßπ NETTOYAGE RADICAL POUR PRODUCTION")
    print("=" * 60)
    
    # Fichiers √† supprimer d√©finitivement
    files_to_delete = [
        # Tests de d√©veloppement
        "test_final_openai_solution.py",
        "test_final_setup_history.py", 
        "test_installation_complete.py",
        "test_security.py",
        "test_curl_fix.py",
        
        # Scripts de debug
        "debug_conversation_manager_fix.py",
        "debug_curl_multiline.py",
        "debug_editable_instructions.py", 
        "debug_openai_issue.py",
        "debug_setup_history_logic_corrections.py",
        "debug_setup_history_modifications.py",
        "debug_setup_history_validation.py",
        
        # Corrections temporaires
        "correction_finale_curl.py",
        "patch_curl_multiline.py",
        "fix_openai_support.py", 
        "validation_setup_history_improvements.py",
        
        # Tests obsol√®tes
        "test_character_cleaning.py",
        "test_conversation_fix.py",
        "test_conversation_integration.py",
        "test_conversation_manager.py", 
        "test_conversation_workflow.py",
        "test_flexible_history_system.py",
        "test_integration_complete.py",
        "test_openai_structure.py",
        "test_profile_custom_instructions.py",
        "test_resume_profile_indicator.py", 
        "test_setup_history_complete.py",
        "test_setup_history_dynamic.py",
        
        # Scripts de nettoyage eux-m√™mes
        "cleanup_final.py",
        "project_cleanup.py",
        
        # Migrations obsol√®tes
        "migration_conversation.py",
        "create_launcher.py",  # D√©j√† supprim√© selon git
        
        # Syst√®me d'agents obsol√®te
        "agents.py",
        "config.yaml",
        
        # Scripts d'installation (garder install_templates.py)
        # "install_templates.py",  # GARDER pour la production
        
        # Logs de debug
        "debug_curl.log",
        
        # API obsol√®te
        "api_client.py",
        "api.py",
        
        # Ce script lui-m√™me
        "production_cleanup.py"
    ]
    
    # Dossiers √† nettoyer
    folders_to_clean = [
        "__pycache__",
        "profiles_backup_conversation",  # Backup obsol√®te
        "development"  # Dossier de d√©veloppement
    ]
    
    removed_count = 0
    
    print("üóëÔ∏è  SUPPRESSION DES FICHIERS:")
    print("-" * 40)
    
    for filename in files_to_delete:
        filepath = Path(filename)
        if filepath.exists():
            try:
                filepath.unlink()
                print(f"‚úÖ Supprim√©: {filename}")
                removed_count += 1
            except Exception as e:
                print(f"‚ùå Erreur: {filename} - {e}")
        else:
            print(f"‚ö™ Absent: {filename}")
    
    print(f"\nüóÇÔ∏è  SUPPRESSION DES DOSSIERS:")
    print("-" * 40)
    
    for foldername in folders_to_clean:
        # Chercher tous les dossiers avec ce nom
        for folder_path in Path(".").rglob(foldername):
            if folder_path.is_dir():
                try:
                    shutil.rmtree(folder_path)
                    print(f"‚úÖ Dossier supprim√©: {folder_path}")
                    removed_count += 1
                except Exception as e:
                    print(f"‚ùå Erreur dossier: {folder_path} - {e}")
    
    # Fichiers YAML obsol√®tes si pas utilis√©s
    yaml_files = list(Path(".").glob("*.yaml"))
    for yaml_file in yaml_files:
        if yaml_file.name == "config.yaml":
            # V√©rifier si vraiment obsol√®te
            print(f"‚ö†Ô∏è  YAML trouv√©: {yaml_file.name} - v√©rification manuelle n√©cessaire")
    
    print(f"\nüìã STRUCTURE FINALE DE PRODUCTION:")
    print("-" * 40)
    print("""
    üìÅ Rob-1/ (PRODUCTION)
    ‚îú‚îÄ‚îÄ üêç main.py                    # Point d'entr√©e principal
    ‚îú‚îÄ‚îÄ üñ•Ô∏è  gui.py                     # Interface utilisateur  
    ‚îú‚îÄ‚îÄ ‚öôÔ∏è  config_manager.py         # Gestion configuration
    ‚îú‚îÄ‚îÄ üí¨ conversation_manager.py    # Gestion conversations
    ‚îú‚îÄ‚îÄ üîß system_profile_generator.py # G√©n√©ration profils syst√®me
    ‚îú‚îÄ‚îÄ üåê api_response_parser.py     # Parser multi-API (NOUVEAU)
    ‚îú‚îÄ‚îÄ üõ†Ô∏è  utils.py                   # Utilitaires
    ‚îú‚îÄ‚îÄ üèóÔ∏è  install_templates.py      # Installation templates
    ‚îú‚îÄ‚îÄ üì¶ requirements.txt           # D√©pendances Python
    ‚îú‚îÄ‚îÄ üöÄ setup.py                   # Script d'installation  
    ‚îú‚îÄ‚îÄ ‚ñ∂Ô∏è  RUN.bat                    # Lanceur Windows
    ‚îú‚îÄ‚îÄ üìñ README.md                  # Documentation principale
    ‚îú‚îÄ‚îÄ üìã Install.md                 # Guide d'installation
    ‚îú‚îÄ‚îÄ üìÑ SetUpFile.md               # Documentation setup
    ‚îú‚îÄ‚îÄ üìú SETUP_HISTORY_FINAL_RESUME.md # Historique
    ‚îî‚îÄ‚îÄ üìÅ Dossiers/
        ‚îú‚îÄ‚îÄ profiles/                 # Profils API (JSON)
        ‚îú‚îÄ‚îÄ templates/                # Templates curl
        ‚îú‚îÄ‚îÄ conversations/            # Historiques conversations
        ‚îî‚îÄ‚îÄ system/                   # Donn√©es syst√®me
    """)
    
    print(f"\nüéØ R√âSUM√â DU NETTOYAGE:")
    print(f"Fichiers supprim√©s: {removed_count}")
    
    print(f"\n‚úÖ FICHIERS CONSERV√âS POUR PRODUCTION:")
    essential_files = [
        "main.py", "gui.py", "config_manager.py", 
        "conversation_manager.py", "system_profile_generator.py",
        "api_response_parser.py", "utils.py", "install_templates.py",
        "requirements.txt", "setup.py", "RUN.bat",
        "README.md", "Install.md", "SetUpFile.md",
        "SETUP_HISTORY_FINAL_RESUME.md"
    ]
    
    for file in essential_files:
        if Path(file).exists():
            print(f"‚úÖ {file}")
        else:
            print(f"‚ùå MANQUANT: {file}")
    
    print(f"\nüéâ NETTOYAGE RADICAL TERMIN√â!")
    print("üöÄ Projet pr√™t pour la production")
    print("‚úÖ OpenAI fonctionnel")
    print("‚úÖ Architecture multi-API en place")
    print("‚úÖ Gemini compatible")
    
    return removed_count

if __name__ == "__main__":
    removed = production_cleanup()
    print(f"\nüèÅ {removed} fichiers/dossiers supprim√©s")
    print("üéØ Projet optimis√© pour la production")
